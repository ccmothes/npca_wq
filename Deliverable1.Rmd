---
title: "Deliverable 1 - DRAFT"
author: "Katie Willi"
date: "`r Sys.Date()`"
output: html_document
---
```{r setup, include=FALSE, reults = 'hide'}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)

library(tidyverse)
library(sf)
library(mapview)
library(jsonlite)
library(rvest)
library(RODBC)

map(list.files(path="src/",
               pattern="*.R",
               full.names=TRUE),
    source)
```


```{r}
# Choose projection
projection <- 3857

# Download Park Boundaries:
parks <- getParkUnits() %>%
  st_transform(projection)

# Pulling in a shapefile of all NHDPlus V2 flow meta-data and shapefile of catchments (pre-downloaded, still need to add that in upstream):
nhd <- read_csv('data/nhd_flow_network.csv') 

nhdplus_contus_catchments <- readRDS('data/us_catchments.RDS')

nhdplus_contus_catchments %>%
  sf::st_transform(projection) %>%
  sf::st_join(parks, left = FALSE) %>%
  saveRDS('data/npca_new/naked_catchments.RDS')

naked_all_catchments <- readRDS('data/npca_new/naked_catchments.RDS')

# Pulling in raw ATTAINS data:
attains_layers <- sf::st_layers(dsn = 'data/ATTAINS_Assessment_20220809.gpkg')

attains_areas <- sf::st_read(dsn = 'data/ATTAINS_Assessment_20220809.gpkg', layer = "attains_au_areas")

attains_lines <- sf::st_read(dsn = 'data/ATTAINS_Assessment_20220809.gpkg', layer = "attains_au_lines")

attains_points <- sf::st_read(dsn = 'data/ATTAINS_Assessment_20220809.gpkg', layer = "attains_au_points")

attains_catchments <- sf::st_read(dsn = 'data/ATTAINS_Assessment_20220809.gpkg', layer = "attains_au_catchments")

attains_attributes <- sf::st_read(dsn = 'data/ATTAINS_Assessment_20220809.gpkg', layer = "attains_au_attributes")

attains_control <- sf::st_read(dsn = 'data/ATTAINS_Assessment_20220809.gpkg', layer = "attains_au_control")

attains_catchassmnt <- sf::st_read(dsn = 'data/ATTAINS_Assessment_20220809.gpkg', layer = "attains_au_catchassmnt")

attains_assmnt_parms <- sf::st_read(dsn = 'data/ATTAINS_Assessment_20220809.gpkg', layer = "attains_au_assmnt_parms")

attains_water_types <- sf::st_read(dsn = 'data/ATTAINS_Assessment_20220809.gpkg', layer = "attains_au_water_types")

attains_meta <- sf::st_read(dsn = 'data/ATTAINS_Assessment_20220809.gpkg', layer = "attains_au_meta")

# link ATTAINS data to park boundaries:
nps_attains_inside <- attains_catchments %>%
 dplyr::filter(nhdplusid %in% naked_all_catchments$FEATUREID) %>%
 sf::st_join(parks, left = FALSE)

saveRDS(nps_attains_inside, 'data/prep/nps_attains_inside.RDS')

# catchments in park boundaries but with no ATTAINS data linked to them
# aka UNASSESSED:
nps_unassessed_inside <- naked_all_catchments %>%
  select(comid = FEATUREID,
         UNIT_NAME) %>%
  # only keep catchments that aren't listed in ATTAINS
  filter(!comid %in% nps_attains_inside$nhdplusid) %>%
  saveRDS('data/nps_unassessed_inside.RDS')
unassessed_inside <- readRDS('data/nps_unassessed_inside.RDS')

inside <- bind_rows(nps_attains_inside, nps_unassessed_inside)
```

```{r}

empty_list <- vector("list", length = nrow(naked_all_catchments))


empty_list <- st_covered_by(naked_all_catchments[i], parks, sparse = TRUE) 


wholly_within <- st_covered_by(naked_all_catchments, parks, sparse = TRUE) %>%
    lapply(function(x) ifelse(is_empty(x), NA, x)) %>% 
    unlist() %>%
  as_tibble() 

naked_all_catchments_more <- cbind(naked_all_catchments, wholly_within) %>%
  rename(wholly_within = value)

naked_crossover_catchments <- naked_all_catchments_more %>%
  filter(is.na(wholly_within)) %>%
  # catchment shapefile created from a `clip` of park boundaries (i.e. were clipped
  # and not contained within the park boundary, they must cross over):
  #dplyr::filter(FEATUREID %in% readRDS('data/npca_new/from_app/nps_outside.RDS')$comid) %>%
  # only want their IDs
  dplyr::select(comid = FEATUREID) %>%
  distinct(.)

getWatersheds <- function(boundary_flowlines){
  dat<- as_tibble(nhdplusTools::get_UM(nhd, boundary_flowlines)) %>%
  write_csv(dat, paste0('data/npca_new/watershed_wip/', boundary_flowlines, '.csv'))
}

boundary_flowlines <- naked_crossover_catchments$comid

comids <- map(boundary_flowlines[1:length(boundary_flowlines)], try(getWatersheds))

comids <- plyr::ldply(list.files(path = 'data/npca_new/watershed_wip/', full.names = TRUE), read_csv)

saveRDS(comids,'data/npca_new/watershed_wip/all_getUM_parks.csv')

comid_merge <- comids %>%
  distinct(.)

nhdplus_contus_catchments <- readRDS('data/npca_new/us_catchments.RDS')

# # the slow way, if NHD catchments aren't downloaded:
# all_getUM_catchments <- nhdplusTools::get_nhdplus(comid = comid_merge$value,
#                                                   realization = 'catchment')


# the fast way (when you have all catchments already downloaded)
all_getUM_catchments <- nhdplus_contus_catchments %>%
  filter(FEATUREID %in% comid_merge$value)
```



