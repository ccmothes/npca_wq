---
title: "Progress Report"
author: "Katie Willi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(sf)
library(mapview)
library(jsonlite)
library(rvest)
library(RODBC)

```

This report aims to update NPCA on the current progress we have made towards analyzing state water quality assessment data for waterbodies within National Park units. To perform this assessment, we have downloaded data from two key sources outlined below.

1)  [**The EPA's ATTAINS database**](https://www.epa.gov/waterdata/get-data-access-public-attains-data#AttainsGeo). This geospatial database represents state water quality status assessment data for all waterbodies of the US assessed by states in their integrated water quality reporting. With this data source, we can investigate the following:

-   Assessment status (i.e., impaired, good, unknown)
-   Impairments, if any
-   Waterbody uses (the state-designated uses for each waterbody assessed, grouped into nationally consistent categories by the EPA)
    -   We can also determine which water body uses are not being supported (i.e., "impaired")

*Resolution of data:* The EPA uses an [automated process](https://www.epa.gov/sites/default/files/2016-04/documents/final_geopilot_report_2016-03-21.pdf) that casts state-submitted geospatial information - whose resolutions vary drastically - into NHDPlus V2 catchments (think of catchments as small sub-watersheds). This relationship between assessment units and catchments is "many-to-many", where one assessment unit can have more than one catchment and/or one catchment can contain multiple assessment units. Inversely, some catchments might have no assessment units, if no waterbodies in a catchment have bees assessed in their state's water quality integrated reporting.

*Frequency of updates:* This database is updated semi-regularly when new state data is made available (the most recent update occurred in August, 2022).

**Map 1:** Example of ATTAINS data at Zion National Park. Assessment data is aggregated/cast to the resolution of NHDPlus V2 catchments. Click each catchment for a list of impairments found within each catchment (if any exist).

```{r}
ZION <- getParkUnits() %>%
  filter(UNIT_CODE == "ZION") %>%
  st_transform(3857)

ZION_line <- sf::st_cast(ZION,"MULTILINESTRING")

water_types <- sf::st_read(dsn = 'data/ATTAINS_Assessment_20220809.gpkg', layer = "attains_au_water_types")

catchments <- sf::st_read(dsn = 'data/ATTAINS_Assessment_20220809.gpkg', layer = "attains_au_catchments") %>%
  .[ZION,] %>%
  merge(water_types, by = "assessmentunitidentifier", all.x = TRUE)

assmnt_parms <- sf::st_read(dsn = 'data/ATTAINS_Assessment_20220809.gpkg', layer = "attains_au_assmnt_parms")

combined <- catchments %>%
  select(nhdplusid, assessmentunitidentifier, ircategory, overallstatus, reportingcycle) %>%
  sp::merge(., filter(select(assmnt_parms, assessmentunitidentifier, parameterstatus, parametername, parametergroupname), parameterstatus == "Cause"), by = "assessmentunitidentifier", all.x = TRUE) %>%
  group_by(nhdplusid) %>%
  mutate(impairments = paste(unique(parametername), collapse = "; ")) %>%
  select(assessmentunitidentifier, nhdplusid, overallstatus, impairments)

mapview(combined, 
        zcol = "overallstatus") +
  mapview(ZION_line, 
        color = "black", 
        alpha.regions = 0, 
        lwd = 2, 
        popup = FALSE, 
        legend = F, 
        homebutton = FALSE,
        label = FALSE)
```

```{r}
SHEN <- getParkUnits() %>%
  filter(UNIT_CODE == "SHEN") %>%
  st_transform(3857)

SHEN_line <- sf::st_cast(SHEN,"MULTILINESTRING")

SHEN_catchments <- sf::st_read(dsn = 'data/ATTAINS_Assessment_20220809.gpkg', layer = "attains_au_catchments") %>%
  .[SHEN,] %>%
  merge(water_types, by = "assessmentunitidentifier", all.x = TRUE)

combined <- SHEN_catchments %>%
  select(nhdplusid, assessmentunitidentifier, ircategory, overallstatus, reportingcycle) %>%
  sp::merge(., filter(select(assmnt_parms, assessmentunitidentifier, parameterstatus, parametername, parametergroupname), parameterstatus == "Cause"), by = "assessmentunitidentifier", all.x = TRUE) %>%
  group_by(nhdplusid) %>%
  mutate(impairments = paste(unique(parametername), collapse = "; ")) %>%
  select(assessmentunitidentifier, nhdplusid, overallstatus, impairments)

mapview(combined, 
        zcol = "overallstatus") +
  mapview(ZION_line, 
        color = "black", 
        alpha.regions = 0, 
        lwd = 2, 
        popup = FALSE, 
        legend = F, 
        homebutton = FALSE,
        label = FALSE)
```



2)  [**NPS's Hydrographic and Impairment Statistics (HIS) database**](https://www.nps.gov/subjects/protectingwater/his.htm). This geospatial database represents NPS waters that are considered impaired by state water quality assessments. That is, this database ***does not*** include any information about waterbodies that are considered good or unknown. However, the HIS database ***does*** identify waters with [special antidegradation standards](https://www.epa.gov/wqs-tech/key-concepts-module-4-antidegradation) (e.g., Outstanding National Resource Waters).

*Resolution of data:* Unlike ATTAINS, NPS casts state water quality information to the High Resolution NHD. This is different than the approach that the EPA takes.

*Frequency of updates:* The HIS database is developed manually, and thus is time intensive and updated less regularly than ATTAINS (for example, the most recent update to Zion National Park's HIS data was in 2017).

**Map 2:** Example of HIS antidegradation data at Zion National Park. Data is aggregated/cast to the High Resolution NHD waterbody features.

```{r}
# db <- "ZION_HIS.mdb"
# con2 <- RODBC::odbcConnectAccess2007(db)
# RODBC::sqlTables(con2, tableType = "TABLE")$TABLE_NAME

tbl303d <- read_csv('tbl303d.csv')

tblORW <- read_csv('tblORW.csv')

ET_Park <- read_csv('ET_Park.csv') %>%
  left_join(tbl303d, by = c("Entity_ID" = "STATE_LIST_ID")) %>%
  left_join(tblORW, by = "ORW_ID") %>%
  mutate(reachcode = as.character(ReachCode))

# UT_ORW <- RODBC::sqlFetch(con2, "UT_ORW") %>%
#   write_csv('UT_ORW.csv')

nhd <- rgdal::readOGR("nhdhr_zion.shp") %>%
  sf::st_as_sf(.) %>%
  sp::merge(., ET_Park, by = "reachcode") %>%
  group_by(reachcode) %>%
  mutate(impairments = paste(unique(PARENT_IMP_DESC), collapse = "; ")) %>%
  select(Entity_ID, reachcode, Designation_Name)
  
mapview::mapview(nhd, zcol = "Designation_Name") +
    mapview(ZION_line, 
        color = "black",
        alpha.regions = 0, 
        lwd = 2, 
        popup = FALSE, 
        legend = F, 
        homebutton = FALSE,
        label = FALSE)
```

### Key differences between the Wild and Scenic River (WSR) assessment and our NPS unit assessment

#### Identifying "unassessed" waters

In the IWSRCC white paper evaluating Wild and Scenic River water quality, river miles were broken down into one of four categories:

-   Good: EPA IR Categories 1 and 2

-   Impaired: EPA IR Categories 4 and 5

-   Unknown: EPA IR Category 3

-   Unassessed: Not included in a state assessment unit

Because ATTAINS is the product of state water quality integrated reports, it inherently only incorporates water bodies that have been acknowledged by their state management agency. Moreover, ATTAINS data is aggregated into NHD catchments, and therefore not linked to specific water features of the NHD. This means that ATTAINS does not provide enough information to easily determine which waters in an NPS park unit would be considered unassessed.

#### More than just river miles

Another key difference in analyzing the water quality status of NPS park units is that we must also incorporate information related to lakes/ponds and coastlines. Therefore, our results cannot be aggregated into miles assessed, miles impaired, etc.

## Choosing an assessment plan

**Example analyses at S**

### Example analyses at Zion

```{r}
pie <- catchments %>%
  distinct(assessmentunitidentifier, .keep_all = TRUE) %>%
  group_by(ircategory) %>%
  summarize(count=n()) %>%
  ungroup()
  #mutate(method_status=ifelse(is.na(method_status), "Ambiguous Colorimetry", method_status))
pie <- pie %>% mutate(ircategory = factor(x = ircategory, levels = ircategory)) %>% 
  mutate(prop = count/sum(pie$count)) %>%  
  mutate(ypos = cumsum(prop)- 0.5*prop) %>%
  mutate(legend = paste0(ircategory, " (", scales::percent(prop), ")"))

ggplot(data=pie, aes(x="", y=count, fill=legend)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  scale_fill_manual(values=c("#009E73","#E69F00","#56B4E9","#CC79A7","#0072B2","#F0E442","#D55E00")) +
  guides(fill=guide_legend(title="IR Statuses by Catchment")) +
  theme_void() + # remove background, grid, numeric label
  theme(text = element_text(size = 20))
```

```{r}
impair <- catchments %>%
  select(nhdplusid, assessmentunitidentifier, ircategory, overallstatus, reportingcycle) %>%
  sp::merge(., filter(select(assmnt_parms, assessmentunitidentifier, parameterstatus, parametername, parametergroupname), parameterstatus == "Cause"), by = "assessmentunitidentifier", all.x = TRUE)

ggplot(impair) +
  geom_
```

### 
